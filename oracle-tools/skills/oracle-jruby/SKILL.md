---
name: oracle-jruby
description: >
  JRuby + oracle_enhanced technical patterns for the oracle-gateway project. This skill
  should be used when writing Oracle::Base models, executing raw SQL against Oracle,
  handling Oracle-specific data types (DATE, NUMBER, CLOB), managing JDBC connections,
  or debugging oracle_enhanced adapter behavior. Use when the user mentions Oracle::Base,
  oracle_enhanced, JDBC, JRuby oracle, Oracle SQL, ROWNUM, Oracle DATE, NLS_DATE,
  Oracle connection, ojdbc, or oracle_enhanced adapter.
---

# Oracle + JRuby Technical Patterns

## The Mental Model

`oracle_enhanced` is an ActiveRecord adapter that speaks JDBC on JRuby, wrapping the
standard Oracle JDBC driver (`ojdbc11.jar`). Most ActiveRecord patterns work, but Oracle
has its own SQL dialect and type system that differs significantly from PostgreSQL.

For a full Oracle vs PostgreSQL SQL dialect comparison, see **`references/oracle-sql.md`**.

## Oracle::Base — The Base Model

All Oracle EBS models inherit from this:

```ruby
# app/models/oracle/base.rb
module Oracle
  class Base < ApplicationRecord
    self.abstract_class = true
    connects_to database: { writing: :oracle, reading: :oracle }
    self.table_name_prefix = "APPS."  # All EBS tables live under APPS schema
  end
end

# Usage
class Item < Oracle::Base
  self.table_name = "MTL_SYSTEM_ITEMS_B"
  self.primary_key = "INVENTORY_ITEM_ID"  # Must be explicit — no id column in EBS
end
```

Always set `primary_key` explicitly. EBS tables rarely have a column named `id`.

## Raw SQL Execution

```ruby
# Simple query
rows = Oracle::Base.connection.execute(
  "SELECT * FROM APPS.MTL_SYSTEM_ITEMS_B WHERE ROWNUM <= 10"
)

# Bind variables — always use these, never interpolate (SQL injection + performance)
rows = Oracle::Base.connection.execute(
  "SELECT * FROM APPS.PO_HEADERS_ALL WHERE ORG_ID = :org_id AND ROWNUM <= :limit",
  org_id: 102, limit: 100
)

# PL/SQL anonymous block
Oracle::Base.connection.execute(
  "BEGIN FND_GLOBAL.APPS_INITIALIZE(:user_id, :resp_id, :app_id); END;",
  user_id: 9297, resp_id: 50876, app_id: 401
)
```

Use `ROWNUM <= n` for limiting rows (not `LIMIT n`). See `references/oracle-sql.md` for
the full PostgreSQL → Oracle translation table.

## Oracle DATE Type

Oracle DATE includes both date AND time (unlike SQL standard). This bites with EBS columns:

```ruby
# oracle_enhanced maps Oracle DATE to Ruby Time — this is correct
item.creation_date  # => 2026-02-20 13:51:21 UTC (Time object, not Date)

# When filtering by date range, always use TRUNC to strip time:
where("TRUNC(CREATION_DATE) = TRUNC(SYSDATE)")

# Or use explicit range:
where("CREATION_DATE >= :start AND CREATION_DATE < :end",
      start: Date.today.beginning_of_day, end: Date.today.end_of_day)
```

## NLS / String Settings

`database.yml` sets `nls_length_semantics: CHAR` — `VARCHAR2(100)` means 100 characters,
not bytes. Important for multi-byte strings.

Oracle is case-sensitive in comparisons by default. Always use `UPPER()` for
case-insensitive search:

```ruby
where("UPPER(VENDOR_NAME) LIKE UPPER(:q)", q: "%#{query}%")
```

## CLOB / Large Text

EBS uses CLOB for long text fields. `oracle_enhanced` handles them transparently, but
avoid pulling CLOBs in bulk queries — select the CLOB column only when needed:

```ruby
# Bad — fetches CLOBs for every row
items = Item.all

# Good — exclude CLOB columns unless needed
items = Item.select(:inventory_item_id, :description, :segment1)
```

## Connection Pool — JRuby Threading

JRuby uses real threads (no GIL, no fork). Puma runs 16 threads, each needs its own DB
connection. Pool size must match thread count:

```yaml
oracle:
  pool: <%= ENV.fetch("ORACLE_POOL_SIZE", 16) %>
```

Key JDBC properties in `database.yml`:

| Property | Value | Purpose |
|----------|-------|---------|
| `oracle.jdbc.ReadTimeout` | `60000` | Kill queries taking > 60s |
| `defaultRowPrefetch` | `100` | Fetch 100 rows per round-trip |
| `oracle.net.keepAlive` | `true` | Prevent VPN/firewall killing idle connections |

## Checking Connection Health

```ruby
# Quick liveness check
Oracle::Base.connection.execute("SELECT 1 FROM DUAL")

# Full readiness (what /health/ready does)
Oracle::Base.connection.execute("SELECT SYSDATE FROM DUAL")
```

## oracle_enhanced Gotchas

- **Primary keys**: The adapter tries to use sequences. For EBS tables with no sequence,
  set `self.sequence_name = :autogenerated` or manage PKs manually.
- **Table name case**: Oracle stores metadata in UPPERCASE. `self.table_name` must be
  uppercase: `"MTL_SYSTEM_ITEMS_B"`, not `"mtl_system_items_b"`.
- **Migrations**: Use `db/oracle_migrate/` — never run standard Rails migrations against
  Oracle. EBS DDL is managed by the Oracle DBA, not Rails.
- **WeakMap patch**: `config/boot.rb` patches oracle_enhanced for JRuby 10. Do not
  remove — see the project's CLAUDE.md for details.

## Additional Resources

- **`references/oracle-sql.md`** — PostgreSQL vs Oracle SQL dialect comparison table and
  pagination patterns
