# Astro Starlight Scaffold Steps

Full step-by-step details for `/add-docs-site`.

---

## Step 1 — Scaffold

### 1.1 `docs/package.json`

```json
{
  "name": "<APP_NAME>-docs",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "astro dev --port 4321",
    "build": "astro build",
    "preview": "astro preview"
  },
  "dependencies": {
    "astro": "^5.6.1",
    "@astrojs/starlight": "^0.37.6",
    "sharp": "^0.34.2"
  }
}
```

### 1.2 `docs/astro.config.mjs`

```js
import { defineConfig } from "astro/config";
import starlight from "@astrojs/starlight";

export default defineConfig({
  base: "/docs",
  outDir: "../public/docs",
  integrations: [
    starlight({
      title: "<APP TITLE>",
      logo: {
        src: "./src/assets/logo.svg",
      },
      favicon: "/favicon.svg",
      defaultLocale: "root",
      locales: {
        root: {
          label: "Español",
          lang: "es",
        },
      },
      customCss: ["./src/styles/custom.css"],
      sidebar: [
        {
          label: "Empezando",
          items: [
            { label: "Introducción", slug: "empezando/introduccion" },
            { label: "Instalación", slug: "empezando/instalacion" },
          ],
        },
        // Add more sections as needed...
      ],
    }),
  ],
});
```

**Key points:**
- `base: "/docs"` — prefixes all generated URLs with `/docs`
- `outDir: "../public/docs"` — builds into Rails `public/` directory
- `defaultLocale: "root"` with `lang: "es"` — Spanish-only, no URL prefix
- Sidebar uses `slug` (not `link`) to reference content collection entries

### 1.3 `docs/tsconfig.json`

```json
{
  "extends": "astro/tsconfigs/strict"
}
```

### 1.4 `docs/src/content.config.ts`

```ts
import { defineCollection } from "astro:content";
import { docsSchema } from "@astrojs/starlight/schema";

export const collections = {
  docs: defineCollection({ schema: docsSchema() }),
};
```

**Important:** This file MUST be at `src/content.config.ts` (not `src/content/config.ts`) for Astro 5.x.

### 1.5 `docs/src/styles/custom.css` — Brand colors

```css
/* Brand colors — replace accent values with your palette */

:root {
  --sl-color-accent-low: #1e3a5f;
  --sl-color-accent: #3b82f6;
  --sl-color-accent-high: #bfdbfe;
  --sl-color-white: #ffffff;
  --sl-color-gray-1: #eceef2;
  --sl-color-gray-2: #c0c2c7;
  --sl-color-gray-3: #888b96;
  --sl-color-gray-4: #545861;
  --sl-color-gray-5: #353841;
  --sl-color-gray-6: #24272f;
  --sl-color-black: #17181c;
}

:root[data-theme="light"] {
  --sl-color-accent-low: #dbeafe;
  --sl-color-accent: #2563eb;
  --sl-color-accent-high: #1e3a5f;
  --sl-color-white: #17181c;
  --sl-color-gray-1: #24272f;
  --sl-color-gray-2: #353841;
  --sl-color-gray-3: #545861;
  --sl-color-gray-4: #888b96;
  --sl-color-gray-5: #c0c2c7;
  --sl-color-gray-6: #eceef2;
  --sl-color-black: #ffffff;
}
```

To customize for a different brand, change `--sl-color-accent` (primary) and derive the `low`/`high` variants.

### 1.6 Assets

- `docs/src/assets/logo.svg` — Logo displayed in Starlight header
- `docs/public/favicon.svg` — Favicon

Copy the app's existing icon/logo to both locations.

### 1.7 Directory structure

```
docs/
├── package.json
├── astro.config.mjs
├── tsconfig.json
├── bun.lock                        # committed
├── public/
│   └── favicon.svg
└── src/
    ├── content.config.ts
    ├── assets/
    │   └── logo.svg
    ├── styles/
    │   └── custom.css
    └── content/
        └── docs/
            ├── index.mdx           # Landing page (template: splash)
            └── <sections>/
                └── <page>.mdx
```

---

## Step 2 — Content pages

### Landing page (`index.mdx`)

```mdx
---
title: <App Name>
description: <Description>
template: splash
hero:
  tagline: <Tagline>
  actions:
    - text: Empezar
      link: /docs/empezando/introduccion/
      icon: right-arrow
      variant: primary
---

import { Card, CardGrid } from "@astrojs/starlight/components";

<CardGrid stagger>
  <Card title="Feature 1" icon="lock">
    Description of feature 1.
  </Card>
  <Card title="Feature 2" icon="setting">
    Description of feature 2.
  </Card>
</CardGrid>
```

**Important:** Hero action `link` values must include the `/docs` base path prefix.

### Regular pages

```mdx
---
title: Page Title
description: Brief description for SEO/sidebar.
---

Content in Spanish. Use:
- Tables for parameters, routes, fields
- Code blocks with language tags for examples
- `:::note`, `:::caution`, `:::tip` for callouts
- Import Starlight components (`Card`, `Tabs`, `Steps`) as needed
```

---

## Step 3 — .gitignore

Add to the repo's `.gitignore`:

```gitignore
# Docs build output (generated by `cd docs && bun run build`)
/public/docs

# Docs dependencies and cache
/docs/node_modules
/docs/.astro
```

---

## Step 4 — Install and verify build

```bash
cd docs && bun install
cd docs && bun run build
```

**Gotcha:** If the first build fails with "Unable to find module for 404.astro", delete `docs/.astro/` and rebuild:

```bash
rm -rf docs/.astro && cd docs && bun run build
```

This is a stale cache issue — only happens on first build.

**Verify:**
- `public/docs/index.html` exists
- All HTML files generated (one per MDX page + 404)
- Links use `/docs/` prefix: `grep 'href="/docs/' public/docs/index.html`

---

## Step 5 — Dockerfile integration

Add to the **build stage**, **after** gem install and **before** `COPY . .`:

```dockerfile
# Install bun for docs site build
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"
```

Add **after** `COPY . .` and **before** `assets:precompile`:

```dockerfile
# Build documentation site
RUN cd docs && bun install --frozen-lockfile && bun run build
```

**Why this order matters:**
1. Bun installed before `COPY . .` — binary cached across builds
2. Docs built after `COPY . .` — needs source files
3. Before `assets:precompile` — `public/docs/` included in asset pipeline copy

**Final image impact:** Zero. Bun and `node_modules` only exist in the build stage.

---

## Step 6 — Procfile.dev

Add a line for the docs dev server:

```
docs: cd docs && bun run dev
```

Starts Starlight's dev server on port 4321 alongside `bin/dev`.

---

## Step 7 — CI workflow

Create `.github/workflows/docs.yml`:

```yaml
name: Docs

on:
  push:
    branches: [main]
    paths: ["docs/**"]
  pull_request:
    paths: ["docs/**"]

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docs
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build
```

**Note:** Pushing this file requires a PAT with the `workflow` scope.

---

## Step 8 — `/update-docs` project-local command

Create `.claude/commands/update-docs.md` in the target Rails project. Use the `/update-docs` skill as the base template, then add a project-specific mapping section:

```markdown
## Code-area to doc-file mapping

- `app/controllers/sessions_controller.rb` or auth → `docs/src/content/docs/autenticacion/`
- `app/models/<name>.rb` → `docs/src/content/docs/<feature>/`
- `config/routes.rb` → may affect multiple pages (route tables)
- New controllers/models → may need new MDX pages + sidebar update
```

Customize paths to match the project's actual feature areas and doc structure.

---

## Step 9 — CHANGELOG

Add under `### Added`:

```markdown
- Astro Starlight documentation site at `/docs` with pages covering <list features>
- `/update-docs` Claude Code skill for keeping documentation in sync with code changes
- Docs build step in Dockerfile (build stage only, zero final image impact)
- Docs dev server in Procfile.dev on port 4321
```
